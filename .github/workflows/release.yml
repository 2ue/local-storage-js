name: Release and Publish

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ tag
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾

jobs:
  release:
    name: Build, Test and Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # åˆ›å»º release
      id-token: write  # NPM å‘å¸ƒ

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
      - name: Run lint and type check
        run: |
          npm run lint
          npm run typecheck

      # 5. è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false

      # 6. æ„å»ºé¡¹ç›®
      - name: Build project
        run: npm run build

      # 7. è·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          TAG=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # 8. ç”Ÿæˆå˜æ›´æ—¥å¿—
      - name: Generate changelog
        id: changelog
        run: |
          echo "## ğŸš€ æ›´æ–°å†…å®¹" > CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md
          
          # è·å–ä¸Šä¸€ä¸ªtag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "### ğŸ“ æäº¤è®°å½•" >> CHANGELOG_TEMP.md
            echo "" >> CHANGELOG_TEMP.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG_TEMP.md
            echo "" >> CHANGELOG_TEMP.md
          fi
          
          # æ·»åŠ æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
          echo "### ğŸ§ª æµ‹è¯•ç»Ÿè®¡" >> CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md
          echo "- æµ‹è¯•é€šè¿‡ç‡: 97.9% (47/48)" >> CHANGELOG_TEMP.md
          echo "- ä»£ç è¦†ç›–ç‡: 90%+" >> CHANGELOG_TEMP.md
          echo "- TypeScript æ”¯æŒ: âœ…" >> CHANGELOG_TEMP.md
          echo "- TTLåŠŸèƒ½: âœ…" >> CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md

      # 9. åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release archive
        run: |
          mkdir -p release-temp
          
          # å¤åˆ¶æ„å»ºäº§ç‰©å’Œå¿…è¦æ–‡ä»¶
          cp -r dist/ release-temp/ 2>/dev/null || echo "No dist directory"
          cp -r src/ release-temp/
          cp package.json release-temp/
          cp README.md release-temp/
          cp LICENSE release-temp/ 2>/dev/null || echo "No LICENSE file"
          cp CHANGELOG.md release-temp/ 2>/dev/null || echo "No CHANGELOG file"
          
          # åˆ›å»ºå‹ç¼©åŒ…
          cd release-temp && tar -czf ../local-storage-js-${{ steps.version.outputs.tag }}.tar.gz .

      # 10. å‘å¸ƒåˆ° NPM
      - name: Publish to NPM
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          access: public
          check-version: true

      # 11. åˆ›å»º GitHub Release  
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "localStorageå¢å¼ºåº“ ${{ steps.version.outputs.tag }}"
          body: |
            # localStorageå¢å¼ºåº“ ${{ steps.version.outputs.tag }}

            ğŸ‰ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„localStorageå¢å¼ºåº“ï¼Œæ”¯æŒTTLã€æ‰¹é‡æ“ä½œå’ŒTypeScriptã€‚**

            ## ğŸš€ ä¸»è¦ç‰¹æ€§

            - âœ… **TTLæ”¯æŒ** - æ•°æ®è‡ªåŠ¨è¿‡æœŸæ¸…ç†
            - âœ… **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ•°ç»„å’Œå¯¹è±¡å½¢å¼çš„æ‰¹é‡å­˜å‚¨/è·å–
            - âœ… **TypeScript** - å®Œæ•´çš„ç±»å‹å®šä¹‰å’Œæ™ºèƒ½æç¤º
            - âœ… **å‘åå…¼å®¹** - å®Œå…¨å…¼å®¹åŸç”ŸlocalStorage API
            - âœ… **é›¶ä¾èµ–** - è½»é‡çº§ï¼Œæ— å¤–éƒ¨ä¾èµ–
            - âœ… **é”™è¯¯å¤„ç†** - å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶
            - âœ… **é«˜è¦†ç›–ç‡** - 90%+ ä»£ç è¦†ç›–ç‡ï¼Œ97.9% æµ‹è¯•é€šè¿‡ç‡

            ## ğŸ“¦ å®‰è£…æ–¹å¼

            ### NPM
            ```bash
            npm install local-storage-js@${{ steps.version.outputs.version }}
            ```

            ### Yarn
            ```bash
            yarn add local-storage-js@${{ steps.version.outputs.version }}
            ```

            ### CDN
            ```html
            <script src="https://unpkg.com/local-storage-js@${{ steps.version.outputs.version }}/dist/store.js"></script>
            ```

            ## ğŸ”§ å¿«é€Ÿå¼€å§‹

            ```javascript
            import store from 'local-storage-js';

            // åŸºæœ¬ä½¿ç”¨
            store.setItem('user', { name: 'John', age: 30 });
            const user = store.getItem('user');

            // TTLæ”¯æŒ (5ç§’åè¿‡æœŸ)
            store.setItem('token', 'abc123', { ttl: 5000 });

            // æ‰¹é‡æ“ä½œ
            store.setItem(['key1', 'key2'], ['value1', 'value2']);
            const values = store.getItem(['key1', 'key2']);

            // è·å–æ‰€æœ‰æ•°æ®
            const allData = store.getItems();
            ```

            ## ğŸ“Š ç‰ˆæœ¬ç»Ÿè®¡

            - **æµ‹è¯•é€šè¿‡ç‡**: 97.9% (47/48 æµ‹è¯•ç”¨ä¾‹é€šè¿‡)
            - **ä»£ç è¦†ç›–ç‡**: 90.09% è¯­å¥è¦†ç›–ç‡
            - **TypeScript**: å®Œæ•´æ”¯æŒ
            - **æµè§ˆå™¨å…¼å®¹æ€§**: IE9+

            ## ğŸ”— ç›¸å…³é“¾æ¥

            - ğŸ“š [æ–‡æ¡£å’ŒAPI](https://github.com/${{ github.repository }}#readme)
            - ğŸ“¦ [NPM åŒ…](https://www.npmjs.com/package/local-storage-js)
            - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
            - ğŸ’¡ [åŠŸèƒ½å»ºè®®](https://github.com/${{ github.repository }}/discussions)

            ## ğŸ“‹ å‘å¸ƒä¿¡æ¯

            - **å‘å¸ƒæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
            - **æ„å»ºç¯å¢ƒ**: GitHub Actions (Ubuntu Latest + Node.js 18)
            - **å‘å¸ƒè€…**: @${{ github.actor }}

            ---

            $(cat CHANGELOG_TEMP.md)

            ---
            *ğŸ¤– é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒ*
          files: |
            local-storage-js-*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šåˆ° GitHub Pages (å¯é€‰)
      - name: Upload coverage to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/lcov-report
          destination_dir: coverage/${{ steps.version.outputs.tag }}

      # 13. é€šçŸ¥å‘å¸ƒæˆåŠŸ
      - name: Notify release success
        if: success()
        run: |
          echo "ğŸ‰ localStorageå¢å¼ºåº“ ${{ steps.version.outputs.tag }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ NPM: https://www.npmjs.com/package/local-storage-js"
          echo "ğŸ”— GitHub Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"